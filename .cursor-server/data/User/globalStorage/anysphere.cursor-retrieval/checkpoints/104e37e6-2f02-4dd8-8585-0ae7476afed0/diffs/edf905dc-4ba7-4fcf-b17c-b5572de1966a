{"fsPath":"\\home\\hendo420\\soraFeed\\src\\components\\VideoCarousel.tsx","fileUuid":"edf905dc-4ba7-4fcf-b17c-b5572de1966a","fileSizeBytes":17058,"numLines":512,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":513,"addedLines":["'use client';","","import React, { useState, useRef, useEffect, useCallback } from 'react';","import useEmblaCarousel from 'embla-carousel-react';","import { Play, Volume2, VolumeX, Heart, User, CheckCircle, ChevronLeft, ChevronRight } from 'lucide-react';","import { SoraFeedItem } from '@/types/sora';","import { remixCache } from '@/lib/remixCache';","","interface VideoCarouselProps {","  item: SoraFeedItem;","  isActive: boolean;","  isUpcoming?: boolean;","  onAddToFavorites?: (item: SoraFeedItem) => void;","  onRemoveFromFavorites?: (postId: string) => void;","  isInFavorites?: (postId: string) => boolean;","  onControlsChange?: (showing: boolean) => void;","}","","export default function VideoCarousel({","  item,","  isActive,","  isUpcoming,","  onAddToFavorites,","  onRemoveFromFavorites,","  isInFavorites,","  onControlsChange","}: VideoCarouselProps) {","  // State","  const [isPlaying, setIsPlaying] = useState(false);","  const [isMuted, setIsMuted] = useState(false);","  const [isLiked, setIsLiked] = useState(false);","  const [showControls, setShowControls] = useState(false);","  const [isHovering, setIsHovering] = useState(false);","  const [isDescriptionExpanded, setIsDescriptionExpanded] = useState(false);","  const [videoWidth, setVideoWidth] = useState<number | null>(null);","  const [isMobile, setIsMobile] = useState(false);","  ","  // Remix state","  const [remixFeed, setRemixFeed] = useState<SoraFeedItem[]>([]);","  const [currentRemixIndex, setCurrentRemixIndex] = useState(0);","  const [loadingRemixes, setLoadingRemixes] = useState(false);","  ","  // Video refs - map by item ID for stable references","  const videoRefsMap = useRef<Map<string, HTMLVideoElement>>(new Map());","  const userPausedRef = useRef(false);","  const hasUserInteractedRef = useRef(false);","  ","  // Configure Embla for horizontal scrolling","  const [emblaRef, emblaApi] = useEmblaCarousel({","    axis: 'x',","    loop: false,","    skipSnaps: false,","    dragFree: false,","    containScroll: 'trimSnaps',","    startIndex: 0,","  });","","  // Get all available items (original + remixes)","  const getAllItems = useCallback((): SoraFeedItem[] => {","    return [item, ...remixFeed];","  }, [item, remixFeed]);","","  // Get current item based on remix index","  const getCurrentItem = useCallback((): SoraFeedItem => {","    const allItems = getAllItems();","    return allItems[currentRemixIndex] || item;","  }, [currentRemixIndex, getAllItems, item]);","","  // Handle slide selection","  const onSelect = useCallback(() => {","    if (!emblaApi) return;","    const selectedIndex = emblaApi.selectedScrollSnap();","    setCurrentRemixIndex(selectedIndex);","  }, [emblaApi]);","","  // Set up event listeners","  useEffect(() => {","    if (!emblaApi) return;","    ","    emblaApi.on('select', onSelect);","    onSelect(); // Call once to set initial state","    ","    return () => {","      emblaApi.off('select', onSelect);","    };","  }, [emblaApi, onSelect]);","","  // Keyboard navigation for horizontal scrolling","  useEffect(() => {","    const handleKeyDown = (e: KeyboardEvent) => {","      if (!isActive || !emblaApi) return;","      ","      // Don't trigger navigation if user is typing in an input field","      const activeElement = document.activeElement;","      const isTyping = activeElement && (","        activeElement.tagName === 'INPUT' || ","        activeElement.tagName === 'TEXTAREA' ||","        (activeElement as HTMLElement).isContentEditable","      );","      ","      if (isTyping) return;","      ","      if (e.key === 'ArrowLeft') {","        e.preventDefault();","        emblaApi.scrollPrev();","      } else if (e.key === 'ArrowRight') {","        e.preventDefault();","        emblaApi.scrollNext();","      }","    };","","    window.addEventListener('keydown', handleKeyDown);","    return () => window.removeEventListener('keydown', handleKeyDown);","  }, [isActive, emblaApi]);","","  // Video control functions","  const getVideoRef = useCallback((itemId: string) => {","    return (el: HTMLVideoElement | null) => {","      if (el) {","        videoRefsMap.current.set(itemId, el);","      } else {","        videoRefsMap.current.delete(itemId);","      }","    };","  }, []);","","  const getCurrentVideo = useCallback(() => {","    const currentItem = getCurrentItem();","    return videoRefsMap.current.get(currentItem.post.id) || null;","  }, [getCurrentItem]);","","  // Control video playback","  const controlVideoPlayback = useCallback(() => {","    const currentVideo = getCurrentVideo();","    if (!currentVideo) return;","","    if (isActive && !userPausedRef.current) {","      if (currentVideo.paused) {","        currentVideo.play().catch(err => console.log('Play failed:', err));","        setIsPlaying(true);","      }","    } else {","      if (!currentVideo.paused) {","        currentVideo.pause();","        setIsPlaying(false);","      }","    }","","    // Mute/unmute","    currentVideo.muted = isMuted || !isActive;","    ","    // Pause other videos","    videoRefsMap.current.forEach((video, itemId) => {","      if (itemId !== getCurrentItem().post.id && !video.paused) {","        video.pause();","      }","    });","  }, [isActive, isMuted, getCurrentVideo, getCurrentItem]);","","  // Effect to control video playback","  useEffect(() => {","    controlVideoPlayback();","  }, [isActive, currentRemixIndex, isMuted, controlVideoPlayback]);","","  // Load remix feed","  useEffect(() => {","    if (isActive && remixFeed.length === 0 && !loadingRemixes) {","      const loadRemixFeed = async () => {","        setLoadingRemixes(true);","        try {","          const remixes = await remixCache.getRemixFeed(item.post.id);","          setRemixFeed(remixes);","        } catch (error) {","          console.error('Failed to load remix feed:', error);","          setRemixFeed([]);","        } finally {","          setLoadingRemixes(false);","        }","      };","      ","      loadRemixFeed();","    }","  }, [isActive, remixFeed.length, loadingRemixes, item.post.id]);","","  // Reset state when item changes","  useEffect(() => {","    // Cleanup all videos","    videoRefsMap.current.forEach(video => {","      video.pause();","      video.muted = true;","      video.currentTime = 0;","    });","    videoRefsMap.current.clear();","    ","    // Reset state","    setRemixFeed([]);","    setCurrentRemixIndex(0);","    setLoadingRemixes(false);","    setIsPlaying(false);","    userPausedRef.current = false;","    hasUserInteractedRef.current = false;","    ","    // Reset carousel to first slide","    if (emblaApi) {","      emblaApi.scrollTo(0, true);","    }","  }, [item.post.id, emblaApi]);","","  // Update favorites","  useEffect(() => {","    if (isInFavorites) {","      setIsLiked(isInFavorites(getCurrentItem().post.id));","    }","  }, [getCurrentItem, isInFavorites]);","","  // Detect mobile","  useEffect(() => {","    const checkMobile = () => {","      const isMobileDevice = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || ","                            (window.matchMedia && window.matchMedia('(max-width: 768px)').matches);","      setIsMobile(isMobileDevice);","    };","    ","    checkMobile();","    window.addEventListener('resize', checkMobile);","    return () => window.removeEventListener('resize', checkMobile);","  }, []);","","  // Controls visibility","  useEffect(() => {","    setShowControls(!isPlaying);","    if (onControlsChange) {","      onControlsChange(!isPlaying);","    }","  }, [isPlaying, onControlsChange]);","","  // Event handlers","  const handleVideoClick = useCallback((e: React.MouseEvent) => {","    e.stopPropagation();","    ","    const currentVideo = getCurrentVideo();","    if (!currentVideo) return;","    ","    if (currentVideo.paused) {","      currentVideo.play().then(() => {","        setIsPlaying(true);","        userPausedRef.current = false;","      }).catch(() => {","        setIsPlaying(false);","      });","    } else {","      currentVideo.pause();","      setIsPlaying(false);","      userPausedRef.current = true;","    }","    ","    hasUserInteractedRef.current = true;","  }, [getCurrentVideo]);","","  const handleVideoMetadata = useCallback((e: React.SyntheticEvent<HTMLVideoElement>) => {","    const video = e.currentTarget;","    if (video.videoWidth && video.videoHeight) {","      const aspectRatio = video.videoWidth / video.videoHeight;","      const viewportWidth = window.innerWidth;","      const viewportHeight = window.innerHeight;","      ","      if (aspectRatio > 1) {","        setVideoWidth(viewportWidth);","      } else {","        const calculatedWidth = viewportHeight * aspectRatio;","        setVideoWidth(calculatedWidth);","      }","    }","  }, []);","","  const toggleMute = useCallback(() => {","    setIsMuted(!isMuted);","  }, [isMuted]);","","  // Render video slide","  const renderVideoSlide = useCallback((videoItem: SoraFeedItem, index: number) => {","    const videoUrl = videoItem.post.attachments[0]?.encodings?.md?.path || ","                     videoItem.post.attachments[0]?.encodings?.source?.path;","    ","    if (!videoUrl) return null;","    ","    const isCurrentSlide = index === currentRemixIndex;","    ","    return (","      <div ","        key={videoItem.post.id}","        className=\"flex-shrink-0 w-full h-full flex items-center justify-center\"","      >","        <div className=\"relative h-full w-full flex items-center justify-center\">","          <div ","            className=\"relative h-full flex items-center justify-center\"","            style={{ ","              width: videoWidth ? `${videoWidth}px` : '100%',","              maxWidth: '100%'","            }}","          >","            <video","              ref={getVideoRef(videoItem.post.id)}","              src={videoUrl}","              className=\"object-contain block w-full h-full\"","              style={{","                width: videoWidth ? `${videoWidth}px` : 'auto',","                height: videoWidth ? 'auto' : '100%',","              }}","              muted={isMuted || !isActive}","              playsInline","              loop","              onLoadedMetadata={handleVideoMetadata}","              preload=\"auto\"","            >","              <source src={videoUrl} type=\"video/mp4\" />","            </video>","          </div>","        </div>","      </div>","    );","  }, [currentRemixIndex, videoWidth, isMuted, isActive, getVideoRef, handleVideoMetadata]);","","  const currentItem = getCurrentItem();","  const allItems = getAllItems();","  const hasRemixes = remixFeed.length > 0;","  const canGoLeft = currentRemixIndex > 0;","  const canGoRight = currentRemixIndex < allItems.length - 1;","","  return (","    <div className=\"relative w-full h-full bg-black overflow-hidden\">","      {/* Video Carousel Container */}","      <div ","        className=\"h-full cursor-pointer select-none\"","        onClick={handleVideoClick}","        onMouseEnter={() => setIsHovering(true)}","        onMouseLeave={() => setIsHovering(false)}","      >","        <div className=\"h-full\" ref={emblaRef}>","          <div className=\"flex h-full\">","            {allItems.map((videoItem, index) => renderVideoSlide(videoItem, index))}","          </div>","        </div>","      </div>","      ","      {/* Controls Overlay */}","      <>","        {/* Play/Pause Button */}","        {showControls && (","          <div className=\"absolute inset-0 flex items-center justify-center z-30 pointer-events-none\">","            <div className=\"bg-black/50 rounded-full p-4 pointer-events-auto\">","              {isPlaying ? (","                <div className=\"w-8 h-8\" />","              ) : (","                <Play className=\"w-8 h-8 text-white fill-white\" />","              )}","            </div>","          </div>","        )}","        ","        {/* Bottom Controls */}","        <div ","          className=\"absolute bottom-4 left-4 right-4 z-40\"","          style={{ ","            opacity: showControls ? 1 : 0,","            transform: showControls ? 'translateY(0)' : 'translateY(20px)',","            transition: 'opacity 0.3s ease, transform 0.3s ease',","            pointerEvents: showControls ? 'auto' : 'none'","          }}","        >","          {/* Remix Navigation */}","          {hasRemixes && (","            <div className=\"flex items-center justify-center mb-4\">","              <div className=\"flex items-center gap-2 bg-black/50 rounded-full px-4 py-2\">","                {/* Previous Button */}","                <button","                  onClick={(e) => {","                    e.stopPropagation();","                    if (emblaApi) emblaApi.scrollPrev();","                  }}","                  disabled={!canGoLeft}","                  className={`p-2 rounded-full transition-all ${","                    canGoLeft ","                      ? 'bg-white/20 hover:bg-white/30 text-white' ","                      : 'bg-white/10 text-white/50 cursor-not-allowed'","                  }`}","                >","                  <ChevronLeft className=\"w-4 h-4\" />","                </button>","                ","                {/* Remix Dots */}","                <div className=\"flex items-center gap-1 mx-2\">","                  {allItems.map((_, index) => (","                    <button","                      key={index}","                      onClick={(e) => {","                        e.stopPropagation();","                        if (emblaApi) emblaApi.scrollTo(index);","                      }}","                      className={`w-2 h-2 rounded-full transition-all ${","                        currentRemixIndex === index","                          ? 'bg-white scale-125' ","                          : 'bg-white/50 hover:bg-white/70'","                      }`}","                    />","                  ))}","                </div>","                ","                {/* Next Button */}","                <button","                  onClick={(e) => {","                    e.stopPropagation();","                    if (emblaApi) emblaApi.scrollNext();","                  }}","                  disabled={!canGoRight}","                  className={`p-2 rounded-full transition-all ${","                    canGoRight ","                      ? 'bg-white/20 hover:bg-white/30 text-white' ","                      : 'bg-white/10 text-white/50 cursor-not-allowed'","                  }`}","                >","                  <ChevronRight className=\"w-4 h-4\" />","                </button>","              </div>","            </div>","          )}","          ","          {/* Video Info */}","          <div className=\"flex items-end justify-between\">","            {/* Left side - Video info */}","            <div className=\"flex-1 min-w-0 mr-4\">","              <div className=\"flex items-center gap-2 mb-2\">","                <div className=\"w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center\">","                  <User className=\"w-4 h-4 text-white\" />","                </div>","                <span className=\"text-white font-semibold text-sm\">","                  Sora User","                </span>","                <CheckCircle className=\"w-4 h-4 text-blue-400\" />","              </div>","","              {currentItem.post.text && (","                <div ","                  className={`text-white text-xs ${currentItem.post.text.length > 100 ? 'cursor-pointer' : ''}`}","                  onClick={(e) => {","                    if (currentItem.post.text && currentItem.post.text.length > 100) {","                      e.stopPropagation();","                      setIsDescriptionExpanded(!isDescriptionExpanded);","                    }","                  }}","                >","                  <p className={isDescriptionExpanded ? '' : 'line-clamp-2'}>","                    {currentItem.post.text}","                  </p>","                  {currentItem.post.text.length > 100 && (","                    <button","                      onClick={(e) => {","                        e.stopPropagation();","                        setIsDescriptionExpanded(!isDescriptionExpanded);","                      }}","                      className=\"text-white/80 hover:text-white text-xs font-semibold mt-1\"","                    >","                      {isDescriptionExpanded ? 'less' : 'more'}","                    </button>","                  )}","                </div>","              )}","            </div>","          ","            {/* Right side - Action buttons */}","            <div className=\"flex flex-col gap-3\">","              {/* Mute Button */}","              <button","                onClick={(e) => {","                  e.stopPropagation();","                  toggleMute();","                }}","                className=\"p-3 rounded-full bg-black/50 hover:bg-black/70 transition-all\"","              >","                {isMuted ? (","                  <VolumeX className=\"w-5 h-5 text-white\" />","                ) : (","                  <Volume2 className=\"w-5 h-5 text-white\" />","                )}","              </button>","","              {/* Like Button */}","              <button","                onClick={(e) => {","                  e.stopPropagation();","                  if (isLiked) {","                    onRemoveFromFavorites?.(currentItem.post.id);","                    setIsLiked(false);","                  } else {","                    onAddToFavorites?.(currentItem);","                    setIsLiked(true);","                  }","                }}","                className=\"p-3 rounded-full bg-black/50 hover:bg-black/70 transition-all\"","              >","                <Heart ","                  className={`w-5 h-5 ${isLiked ? 'text-red-500 fill-red-500' : 'text-white'}`} ","                />","              </button>","            </div>","          </div>","        </div>","      </>","    </div>","  );","}",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000005,1000006,1000001,1000007,1000008,1000009,1000010,1000011,1000012,1000013,1000014,1000015,1000001,1000016,1000017,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000035,1000036,1000037,1000038,1000034,1000039,1000040,1000041,1000042,1000034,1000043,1000044,1000045,1000046,1000047,1000048,1000049,1000050,1000051,1000001,1000052,1000053,1000054,1000055,1000001,1000056,1000057,1000058,1000059,1000060,1000001,1000061,1000062,1000063,1000064,1000065,1000066,1000001,1000067,1000068,1000063,1000069,1000070,1000071,1000069,1000072,1000073,1000074,1000075,1000001,1000076,1000068,1000077,1000078,1000079,1000080,1000081,1000082,1000083,1000084,1000085,1000086,1000079,1000087,1000079,1000088,1000089,1000090,1000091,1000089,1000092,1000093,1000074,1000001,1000094,1000095,1000096,1000001,1000097,1000098,1000099,1000100,1000101,1000102,1000103,1000093,1000074,1000104,1000001,1000105,1000106,1000107,1000108,1000001,1000109,1000110,1000111,1000112,1000001,1000113,1000114,1000115,1000116,1000093,1000117,1000118,1000119,1000120,1000093,1000121,1000001,1000122,1000123,1000069,1000124,1000125,1000126,1000127,1000093,1000128,1000129,1000001,1000130,1000068,1000131,1000132,1000001,1000133,1000068,1000134,1000135,1000136,1000137,1000138,1000139,1000140,1000141,1000142,1000143,1000144,1000145,1000146,1000079,1000147,1000121,1000148,1000001,1000149,1000068,1000150,1000151,1000152,1000153,1000154,1000128,1000155,1000069,1000156,1000157,1000158,1000159,1000160,1000161,1000162,1000069,1000163,1000164,1000165,1000121,1000166,1000001,1000167,1000068,1000168,1000169,1000121,1000170,1000001,1000171,1000068,1000172,1000173,1000174,1000175,1000074,1000069,1000176,1000177,1000178,1000104,1000001,1000179,1000068,1000180,1000181,1000182,1000121,1000183,1000001,1000184,1000185,1000186,1000069,1000111,1000112,1000069,1000187,1000188,1000116,1000189,1000190,1000120,1000191,1000117,1000192,1000193,1000194,1000121,1000069,1000195,1000196,1000001,1000197,1000198,1000199,1000200,1000201,1000202,1000079,1000203,1000204,1000102,1000205,1000206,1000093,1000121,1000104,1000001,1000207,1000208,1000209,1000001,1000210,1000211,1000212,1000213,1000069,1000214,1000069,1000215,1000069,1000216,1000217,1000218,1000219,1000220,1000221,1000222,1000223,1000224,1000225,1000226,1000227,1000228,1000229,1000230,1000231,1000232,1000233,1000234,1000235,1000236,1000237,1000238,1000239,1000240,1000241,1000242,1000243,1000244,1000245,1000246,1000247,1000248,1000249,1000001,1000250,1000251,1000252,1000253,1000254,1000001,1000255,1000256,1000257,1000217,1000258,1000259,1000260,1000261,1000220,1000262,1000263,1000264,1000245,1000246,1000247,1000079,1000265,1000266,1000267,1000268,1000269,1000270,1000271,1000272,1000273,1000274,1000275,1000276,1000245,1000277,1000278,1000279,1000280,1000281,1000282,1000283,1000284,1000285,1000286,1000287,1000288,1000289,1000290,1000291,1000292,1000293,1000294,1000295,1000296,1000297,1000298,1000299,1000300,1000301,1000302,1000303,1000304,1000305,1000306,1000307,1000308,1000309,1000310,1000311,1000312,1000313,1000314,1000315,1000316,1000317,1000318,1000319,1000320,1000321,1000322,1000323,1000324,1000325,1000308,1000326,1000294,1000295,1000296,1000327,1000298,1000328,1000300,1000329,1000302,1000303,1000304,1000305,1000330,1000307,1000331,1000276,1000332,1000333,1000334,1000335,1000336,1000337,1000338,1000339,1000340,1000325,1000341,1000342,1000343,1000344,1000331,1000001,1000345,1000346,1000347,1000295,1000348,1000349,1000350,1000351,1000298,1000305,1000352,1000353,1000354,1000355,1000312,1000314,1000315,1000356,1000317,1000357,1000358,1000359,1000360,1000361,1000325,1000275,1000276,1000333,1000362,1000363,1000364,1000365,1000366,1000367,1000368,1000369,1000370,1000371,1000372,1000373,1000374,1000375,1000376,1000377,1000001,1000378,1000365,1000366,1000367,1000379,1000380,1000381,1000382,1000383,1000384,1000385,1000369,1000370,1000371,1000386,1000387,1000388,1000377,1000276,1000245,1000246,1000389,1000390,1000391,1000015,1000001]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}