{"fsPath":"\\home\\hendo420\\soraFeed\\src\\app\\api\\search\\route.ts","fileUuid":"44d17d2a-9bb8-4bcd-a7b3-ca46f36c6d38","fileSizeBytes":4446,"numLines":137,"diffChanges":[{"originalStartLineNumberOneIndexed":22,"originalEndLineNumberExclusiveOneIndexed":23,"modifiedStartLineNumberOneIndexed":22,"modifiedEndLineNumberExclusiveOneIndexed":45,"addedLines":["    // Enable pg_trgm extension for fuzzy matching if not already enabled","    try {","      await client.query('CREATE EXTENSION IF NOT EXISTS pg_trgm');","    } catch (err) {","      // Extension might already exist, ignore error","      console.log('pg_trgm extension check:', err);","    }","","    // Create GIN index on text for trigram similarity if not exists","    try {","      await client.query(`","        CREATE INDEX IF NOT EXISTS idx_sora_posts_text_trgm ","        ON sora_posts USING gin(text gin_trgm_ops)","      `);","    } catch (err) {","      console.log('Trigram index check:', err);","    }","","    // Advanced search query with multiple matching strategies:","    // 1. Full-text search (ts_rank for relevance)","    // 2. Partial match (ILIKE for case-insensitive substring)","    // 3. Fuzzy match (similarity for typo tolerance)","    // Results are weighted by: text relevance + remix count"],"tokenizedAddedLines":[1000055,1000056,1000057,1000058,1000059,1000060,15,4,1000061,1000056,1000062,1000063,1000064,1000065,1000058,1000066,15,4,1000067,1000068,1000069,1000070,1000071]},{"originalStartLineNumberOneIndexed":24,"originalEndLineNumberExclusiveOneIndexed":24,"modifiedStartLineNumberOneIndexed":46,"modifiedEndLineNumberExclusiveOneIndexed":88,"addedLines":["      WITH search_results AS (","        SELECT ","          post_data,","          profile_data,","          text,","          posted_at,","          updated_at,","          like_count,","          view_count,","          remix_count,","          permalink,","          -- Calculate combined relevance score","          (","            -- Full-text search relevance (0-1 scale)","            COALESCE(ts_rank_cd(","              to_tsvector('english', COALESCE(text, '')),","              plainto_tsquery('english', $1)","            ), 0) * 0.4 +","            -- Partial match score (0-1 scale)","            CASE ","              WHEN LOWER(COALESCE(text, '')) LIKE LOWER('%' || $1 || '%') THEN 0.3","              ELSE 0","            END +","            -- Fuzzy match score (0-1 scale, using similarity)","            COALESCE(similarity(LOWER(COALESCE(text, '')), LOWER($1)), 0) * 0.3","          ) as text_relevance,","          -- Normalize remix count (0-1 scale, using log for better distribution)","          CASE ","            WHEN remix_count > 0 THEN LEAST(LOG(remix_count + 1) / 10, 1)","            ELSE 0","          END as remix_score","        FROM sora_posts","        WHERE ","          -- Full-text search match","          to_tsvector('english', COALESCE(text, '')) @@ plainto_tsquery('english', $1)","          OR","          -- Partial match (case-insensitive)","          LOWER(COALESCE(text, '')) LIKE LOWER('%' || $1 || '%')","          OR","          -- Fuzzy match (similarity threshold of 0.3)","          similarity(LOWER(COALESCE(text, '')), LOWER($1)) > 0.3","      )"],"tokenizedAddedLines":[1000072,1000073,1000074,1000075,1000076,1000077,1000078,1000079,1000080,1000081,1000082,1000083,1000084,1000085,1000086,1000087,1000088,1000089,1000090,1000091,1000092,1000093,1000094,1000095,1000096,1000097,1000098,1000099,1000100,1000101,1000102,1000103,1000104,1000105,1000106,1000107,1000108,1000109,1000107,1000110,1000111,1000112]},{"originalStartLineNumberOneIndexed":33,"originalEndLineNumberExclusiveOneIndexed":37,"modifiedStartLineNumberOneIndexed":97,"modifiedEndLineNumberExclusiveOneIndexed":105,"addedLines":["        permalink,","        text_relevance,","        remix_score","      FROM search_results","      ORDER BY ","        -- Combined score: 60% text relevance + 40% remix score","        (text_relevance * 0.6 + remix_score * 0.4) DESC,","        posted_at DESC"],"tokenizedAddedLines":[1000113,1000114,1000115,1000116,1000117,1000118,1000119,1000120]},{"originalStartLineNumberOneIndexed":49,"originalEndLineNumberExclusiveOneIndexed":49,"modifiedStartLineNumberOneIndexed":117,"modifiedEndLineNumberExclusiveOneIndexed":120,"addedLines":["    if (result.rows.length > 0) {","      console.log(`ðŸ“Š Top result: text_relevance=${result.rows[0].text_relevance?.toFixed(3)}, remix_score=${result.rows[0].remix_score?.toFixed(3)}`);","    }"],"tokenizedAddedLines":[1000121,1000122,15]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}