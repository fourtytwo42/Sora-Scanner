{"fsPath":"\\home\\hendo420\\soraFeed\\scripts\\test_minimal_auth.js","fileUuid":"8b10bd37-2e28-4dbc-8a34-4c307d2f2f2a","fileSizeBytes":8927,"numLines":248,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":249,"addedLines":["#!/usr/bin/env node","","/**"," * Test script to determine the minimal authentication required for Sora API"," * Since we're only fetching public video lists, we might not need all cookies"," */","","require('dotenv').config();","const fs = require('fs');","const path = require('path');","","const SORA_BASE_URL = 'https://sora.chatgpt.com/backend/project_y';","","// Test different authentication combinations","const authCombinations = [","  {","    name: 'Bearer Token Only',","    headers: {","      'Authorization': `Bearer ${process.env.AUTH_BEARER_TOKEN}`,","      'Accept': '*/*',","      'Accept-Language': 'en-US,en;q=0.9',","      'User-Agent': process.env.USER_AGENT || 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36',","      'Referer': 'https://sora.chatgpt.com/',","    }","  },","  {","    name: 'Bearer Token + Basic Cookies (no session)',","    headers: {","      'Authorization': `Bearer ${process.env.AUTH_BEARER_TOKEN}`,","      'Accept': '*/*',","      'Accept-Language': 'en-US,en;q=0.9',","      'User-Agent': process.env.USER_AGENT || 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36',","      'Referer': 'https://sora.chatgpt.com/',","      'Cookie': [","        process.env.CF_CLEARANCE ? `cf_clearance=${process.env.CF_CLEARANCE}` : null,","        process.env.CF_BM ? `__cf_bm=${process.env.CF_BM}` : null,","        process.env.OAI_DID ? `oai-did=${process.env.OAI_DID}` : null,","      ].filter(Boolean).join('; ')","    }","  },","  {","    name: 'Bearer Token + Session Cookie Only',","    headers: {","      'Authorization': `Bearer ${process.env.AUTH_BEARER_TOKEN}`,","      'Accept': '*/*',","      'Accept-Language': 'en-US,en;q=0.9',","      'User-Agent': process.env.USER_AGENT || 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36',","      'Referer': 'https://sora.chatgpt.com/',","      'Cookie': `__Secure-next-auth.session-token=${process.env.COOKIE_SESSION}`","    }","  },","  {","    name: 'Full Authentication (Current Implementation)',","    headers: {","      'Authorization': `Bearer ${process.env.AUTH_BEARER_TOKEN}`,","      'Accept': '*/*',","      'Accept-Language': 'en-US,en;q=0.9',","      'User-Agent': process.env.USER_AGENT || 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36',","      'Referer': 'https://sora.chatgpt.com/',","      'Cookie': [","        `__Secure-next-auth.session-token=${process.env.COOKIE_SESSION}`,","        process.env.CF_CLEARANCE ? `cf_clearance=${process.env.CF_CLEARANCE}` : null,","        process.env.CF_BM ? `__cf_bm=${process.env.CF_BM}` : null,","        process.env.OAI_SC ? `oai-sc=${process.env.OAI_SC}` : null,","        process.env.OAI_DID ? `oai-did=${process.env.OAI_DID}` : null,","      ].filter(Boolean).join('; ')","    }","  }","];","","// Endpoints to test","const endpointsToTest = [","  {","    name: 'Latest Feed',","    url: `${SORA_BASE_URL}/feed?limit=5&cut=nf2_latest`,","  },","  {","    name: 'Top Feed', ","    url: `${SORA_BASE_URL}/feed?limit=5&cut=nf2_top`,","  }","];","","async function testAuthCombination(url, headers, authName, endpointName) {","  try {","    console.log(`\\n🔍 Testing: ${endpointName} with ${authName}`);","    console.log(`   URL: ${url}`);","    ","    const response = await fetch(url, {","      method: 'GET',","      headers: headers,","    });","","    console.log(`   Status: ${response.status} ${response.statusText}`);","","    if (response.status === 200) {","      const contentType = response.headers.get('content-type');","      if (contentType && contentType.includes('application/json')) {","        try {","          const data = await response.json();","          console.log(`   ✅ SUCCESS! Got ${data.items?.length || 0} videos`);","          ","          if (data.items && data.items.length > 0) {","            const firstItem = data.items[0];","            console.log(`   📹 First video: \"${firstItem.post?.text?.substring(0, 40) || 'No title'}...\"`);","            console.log(`   👤 By: ${firstItem.profile?.display_name || firstItem.profile?.username || 'Unknown'}`);","            console.log(`   🎬 Has video URL: ${!!firstItem.post?.attachments?.[0]?.encodings?.md?.path}`);","          }","          ","          return {","            success: true,","            status: response.status,","            itemCount: data.items?.length || 0,","            data: data","          };","        } catch (parseError) {","          console.log(`   ❌ Failed to parse JSON: ${parseError.message}`);","        }","      } else {","        const text = await response.text();","        console.log(`   ⚠️  Non-JSON response: ${text.substring(0, 100)}`);","      }","    } else if (response.status === 401) {","      console.log(`   🚫 Unauthorized - Missing or invalid authentication`);","    } else if (response.status === 403) {","      console.log(`   🚫 Forbidden - Likely Cloudflare challenge or insufficient permissions`);","    } else {","      const text = await response.text();","      console.log(`   ❌ Error ${response.status}: ${text.substring(0, 100)}`);","    }","","    return {","      success: false,","      status: response.status","    };","","  } catch (error) {","    console.log(`   💥 Network error: ${error.message}`);","    return {","      success: false,","      error: error.message","    };","  }","}","","async function runMinimalAuthTests() {","  console.log('🧪 Testing minimal authentication requirements for Sora API...\\n');","  console.log('🎯 Goal: Determine if we need session cookies for public video lists\\n');","  console.log('=' .repeat(80));","  ","  // Check if we have the bearer token","  if (!process.env.AUTH_BEARER_TOKEN) {","    console.error('❌ AUTH_BEARER_TOKEN not found in environment variables');","    console.log('💡 Make sure you have a .env file with the bearer token');","    process.exit(1);","  }","","  const results = {","    timestamp: new Date().toISOString(),","    tests: []","  };","","  // Test each endpoint with each auth combination","  for (const endpoint of endpointsToTest) {","    console.log(`\\n📡 ENDPOINT: ${endpoint.name}`);","    console.log('-'.repeat(60));","    ","    const endpointResults = {","      endpoint: endpoint,","      authTests: []","    };","","    for (const authCombo of authCombinations) {","      const result = await testAuthCombination(","        endpoint.url, ","        authCombo.headers, ","        authCombo.name,","        endpoint.name","      );","      ","      endpointResults.authTests.push({","        authMethod: authCombo.name,","        result: result","      });","","      // Add a small delay between requests","      await new Promise(resolve => setTimeout(resolve, 1000));","    }","    ","    results.tests.push(endpointResults);","  }","","  // Save detailed results","  const outputFile = path.join(__dirname, 'minimal_auth_test_results.json');","  fs.writeFileSync(outputFile, JSON.stringify(results, null, 2));","  ","  console.log('\\n' + '='.repeat(80));","  console.log('📊 MINIMAL AUTH ANALYSIS');","  console.log('='.repeat(80));","  ","  let minimalWorkingAuth = null;","  ","  results.tests.forEach(test => {","    console.log(`\\n📡 ${test.endpoint.name}:`);","    test.authTests.forEach(authTest => {","      const status = authTest.result.success ? '✅' : '❌';","      const statusCode = authTest.result.status || 'ERROR';","      const itemCount = authTest.result.itemCount || 0;","      console.log(`   ${status} ${authTest.authMethod}: ${statusCode}${authTest.result.success ? ` (${itemCount} items)` : ''}`);","      ","      // Track the minimal working auth (first successful one in order)","      if (authTest.result.success && !minimalWorkingAuth) {","        minimalWorkingAuth = authTest.authMethod;","      }","    });","  });","","  console.log('\\n🎯 CONCLUSION:');","  if (minimalWorkingAuth) {","    console.log(`   ✅ Minimal working authentication: \"${minimalWorkingAuth}\"`);","    ","    if (minimalWorkingAuth === 'Bearer Token Only') {","      console.log('   🚀 GREAT NEWS! We only need the Bearer token for public feeds!');","      console.log('   💡 We can remove the session cookie requirement');","      console.log('   🔧 This simplifies user authentication significantly');","    } else if (minimalWorkingAuth === 'Bearer Token + Basic Cookies (no session)') {","      console.log('   👍 We need Bearer token + basic cookies (no session)');","      console.log('   💡 Session cookie is not required for public feeds');","    } else if (minimalWorkingAuth === 'Bearer Token + Session Cookie Only') {","      console.log('   ⚠️  We need both Bearer token and session cookie');","      console.log('   💭 Session cookie is required even for public feeds');","    } else {","      console.log('   📝 Full authentication is required');","    }","  } else {","    console.log('   ❌ No authentication method worked');","    console.log('   🔍 All methods failed - check token validity');","  }","","  console.log(`\\n💾 Detailed results saved to: ${outputFile}`);","  console.log('\\n🏁 Test completed!');","}","","// Run the tests","runMinimalAuthTests().catch(error => {","  console.error('💥 Script failed:', error);","  process.exit(1);","});",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000005,1000001,1000006,1000007,1000008,1000001,1000009,1000001,1000010,1000011,1000012,1000013,1000014,1000015,1000016,1000017,1000018,1000019,1000020,1000021,1000012,1000022,1000014,1000015,1000016,1000017,1000018,1000019,1000023,1000024,1000025,1000026,1000027,1000020,1000021,1000012,1000028,1000014,1000015,1000016,1000017,1000018,1000019,1000029,1000020,1000021,1000012,1000030,1000014,1000015,1000016,1000017,1000018,1000019,1000023,1000031,1000024,1000025,1000032,1000026,1000027,1000020,1000033,1000034,1000001,1000035,1000036,1000012,1000037,1000038,1000021,1000012,1000039,1000040,1000033,1000034,1000001,1000041,1000042,1000043,1000044,1000045,1000046,1000047,1000048,1000049,1000001,1000050,1000001,1000051,1000052,1000053,1000054,1000055,1000056,1000057,1000058,1000059,1000060,1000061,1000062,1000063,1000057,1000064,1000065,1000066,1000067,1000068,1000069,1000070,1000071,1000072,1000073,1000074,1000075,1000076,1000077,1000078,1000079,1000080,1000081,1000082,1000083,1000020,1000001,1000084,1000085,1000086,1000087,1000001,1000088,1000089,1000084,1000085,1000090,1000087,1000033,1000091,1000001,1000092,1000093,1000094,1000095,1000096,1000097,1000098,1000099,1000100,1000101,1000033,1000001,1000102,1000103,1000104,1000105,1000001,1000106,1000107,1000108,1000109,1000045,1000110,1000111,1000112,1000087,1000001,1000113,1000114,1000115,1000116,1000117,1000118,1000119,1000120,1000121,1000122,1000123,1000124,1000001,1000125,1000126,1000020,1000045,1000127,1000033,1000001,1000128,1000129,1000130,1000096,1000131,1000132,1000133,1000096,1000134,1000096,1000135,1000136,1000137,1000138,1000139,1000140,1000141,1000120,1000142,1000143,1000144,1000076,1000049,1000145,1000001,1000146,1000147,1000148,1000045,1000149,1000150,1000151,1000152,1000153,1000154,1000155,1000156,1000157,1000158,1000081,1000159,1000020,1000160,1000161,1000162,1000033,1000001,1000163,1000164,1000091,1000001,1000165,1000166,1000167,1000168,1000169,1000001]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}