{"fsPath":"\\home\\hendo420\\soraFeed\\scripts\\scanner.js","fileUuid":"ca602c87-d7a1-4434-8594-19584d0eb887","fileSizeBytes":7770,"numLines":288,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":289,"addedLines":["const { Pool } = require('pg');","const https = require('https');","require('dotenv').config();","","// Database connection","const pool = new Pool({","  host: process.env.DB_HOST || 'localhost',","  port: parseInt(process.env.DB_PORT || '5432'),","  database: process.env.DB_NAME || 'sora_feed',","  user: process.env.DB_USER || 'postgres',","  password: process.env.DB_PASSWORD || '',","  max: 20,","  idleTimeoutMillis: 30000,","  connectionTimeoutMillis: 2000,","});","","// Fetch feed from Sora API","function fetchSoraFeed() {","  return new Promise((resolve, reject) => {","    const options = {","      hostname: 'sora.chatgpt.com',","      path: '/backend/project_y/feed/latest?limit=200',","      method: 'GET',","      headers: {","        'Accept': 'application/json',","        'User-Agent': 'SoraFeedScanner/1.0'","      }","    };","","    https.get(options, (res) => {","      let data = '';","","      res.on('data', (chunk) => {","        data += chunk;","      });","","      res.on('end', () => {","        try {","          const jsonData = JSON.parse(data);","          resolve(jsonData);","        } catch (error) {","          reject(new Error(`JSON parse error: ${error.message}`));","        }","      });","    }).on('error', (error) => {","      reject(error);","    });","  });","}","","// Initialize database tables","async function initDatabase() {","  const client = await pool.connect();","  try {","    console.log('🔧 Initializing database...');","","    // Create posts table","    await client.query(`","      CREATE TABLE IF NOT EXISTS sora_posts (","        id TEXT PRIMARY KEY,","        post_data JSONB NOT NULL,","        profile_data JSONB NOT NULL,","        text TEXT,","        posted_at BIGINT,","        updated_at BIGINT,","        like_count INTEGER DEFAULT 0,","        view_count INTEGER DEFAULT 0,","        remix_count INTEGER DEFAULT 0,","        permalink TEXT,","        indexed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,","        last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,","        UNIQUE(id)","      );","    `);","","    // Create indexes","    await client.query(`","      CREATE INDEX IF NOT EXISTS idx_sora_posts_posted_at ON sora_posts(posted_at DESC);","    `);","    ","    await client.query(`","      CREATE INDEX IF NOT EXISTS idx_sora_posts_indexed_at ON sora_posts(indexed_at DESC);","    `);","","    await client.query(`","      CREATE INDEX IF NOT EXISTS idx_sora_posts_text ON sora_posts USING gin(to_tsvector('english', COALESCE(text, '')));","    `);","","    // Create scanner_stats table","    await client.query(`","      CREATE TABLE IF NOT EXISTS scanner_stats (","        id SERIAL PRIMARY KEY,","        total_scanned INTEGER DEFAULT 0,","        new_posts INTEGER DEFAULT 0,","        duplicate_posts INTEGER DEFAULT 0,","        errors INTEGER DEFAULT 0,","        last_scan_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,","        scan_duration_ms INTEGER DEFAULT 0,","        status TEXT DEFAULT 'idle',","        error_message TEXT","      );","    `);","","    // Initialize scanner_stats if empty","    const statsCheck = await client.query('SELECT COUNT(*) FROM scanner_stats');","    if (parseInt(statsCheck.rows[0].count) === 0) {","      await client.query(`","        INSERT INTO scanner_stats (total_scanned, new_posts, duplicate_posts, errors, status)","        VALUES (0, 0, 0, 0, 'idle')","      `);","    }","","    console.log('✅ Database initialized successfully');","  } catch (error) {","    console.error('❌ Database initialization error:', error);","    throw error;","  } finally {","    client.release();","  }","}","","// Process and store posts","async function processPosts(feedData) {","  const client = await pool.connect();","  let newPosts = 0;","  let duplicates = 0;","  ","  try {","    await client.query('BEGIN');","","    if (!feedData.items || !Array.isArray(feedData.items)) {","      throw new Error('Invalid feed data structure');","    }","","    for (const item of feedData.items) {","      const { post, profile } = item;","      ","      // Check if post already exists","      const existCheck = await client.query(","        'SELECT id FROM sora_posts WHERE id = $1',","        [post.id]","      );","","      if (existCheck.rows.length > 0) {","        duplicates++;","        continue;","      }","","      // Insert new post","      await client.query(`","        INSERT INTO sora_posts (","          id, post_data, profile_data, text, posted_at, updated_at,","          like_count, view_count, remix_count, permalink","        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)","        ON CONFLICT (id) DO NOTHING","      `, [","        post.id,","        JSON.stringify(post),","        JSON.stringify(profile),","        post.text || null,","        post.posted_at || 0,","        post.updated_at || 0,","        0, // like_count - not in API response","        0, // view_count - not in API response","        0, // remix_count - not in API response","        post.permalink || null","      ]);","","      newPosts++;","    }","","    await client.query('COMMIT');","    return { newPosts, duplicates, total: feedData.items.length };","  } catch (error) {","    await client.query('ROLLBACK');","    throw error;","  } finally {","    client.release();","  }","}","","// Update scanner statistics","async function updateStats(stats, duration, error = null) {","  try {","    await pool.query(`","      UPDATE scanner_stats","      SET ","        total_scanned = total_scanned + $1,","        new_posts = new_posts + $2,","        duplicate_posts = duplicate_posts + $3,","        errors = errors + $4,","        last_scan_at = CURRENT_TIMESTAMP,","        scan_duration_ms = $5,","        status = $6,","        error_message = $7","      WHERE id = 1","    `, [","      stats.total || 0,","      stats.newPosts || 0,","      stats.duplicates || 0,","      error ? 1 : 0,","      duration,","      error ? 'error' : 'success',","      error ? error.message : null","    ]);","  } catch (err) {","    console.error('Failed to update stats:', err);","  }","}","","// Main scan function","async function scanFeed() {","  const startTime = Date.now();","  console.log(`\\n🔍 [${new Date().toISOString()}] Starting scan...`);","","  try {","    // Update status to scanning","    await pool.query(`UPDATE scanner_stats SET status = 'scanning' WHERE id = 1`);","","    // Fetch feed","    const feedData = await fetchSoraFeed();","    console.log(`📥 Fetched ${feedData.items?.length || 0} posts from API`);","","    // Process posts","    const result = await processPosts(feedData);","    const duration = Date.now() - startTime;","","    console.log(`✅ Scan complete:`);","    console.log(`   - New posts: ${result.newPosts}`);","    console.log(`   - Duplicates: ${result.duplicates}`);","    console.log(`   - Total: ${result.total}`);","    console.log(`   - Duration: ${duration}ms`);","","    // Update statistics","    await updateStats({","      total: result.total,","      newPosts: result.newPosts,","      duplicates: result.duplicates","    }, duration);","","  } catch (error) {","    const duration = Date.now() - startTime;","    console.error(`❌ Scan error:`, error.message);","    await updateStats({}, duration, error);","  }","}","","// Main function","async function main() {","  try {","    console.log('🚀 Sora Feed Scanner Starting...');","    console.log('📊 Database:', process.env.DB_NAME || 'sora_feed');","    ","    // Initialize database","    await initDatabase();","","    // Run initial scan","    await scanFeed();","","    // Schedule scans every 10 seconds","    console.log('⏰ Scheduling scans every 10 seconds...');","    setInterval(scanFeed, 10000);","","  } catch (error) {","    console.error('❌ Fatal error:', error);","    process.exit(1);","  }","}","","// Handle graceful shutdown","process.on('SIGINT', async () => {","  console.log('\\n🛑 Shutting down scanner...');","  await pool.query(`UPDATE scanner_stats SET status = 'stopped' WHERE id = 1`);","  await pool.end();","  process.exit(0);","});","","process.on('SIGTERM', async () => {","  console.log('\\n🛑 Shutting down scanner...');","  await pool.query(`UPDATE scanner_stats SET status = 'stopped' WHERE id = 1`);","  await pool.end();","  process.exit(0);","});","","// Start the scanner","main();","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000012,1000013,1000014,1000003,1000015,1000016,1000017,1000018,1000019,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000003,1000027,1000028,1000003,1000029,1000030,1000031,1000003,1000032,1000033,1000034,1000035,1000036,1000037,1000038,1000031,1000039,1000040,1000041,1000042,1000043,1000003,1000044,1000045,1000046,1000047,1000048,1000003,1000049,1000050,1000051,1000052,1000053,1000054,1000055,1000056,1000057,1000058,1000059,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000003,1000067,1000050,1000068,1000066,1000069,1000050,1000070,1000066,1000003,1000050,1000071,1000066,1000003,1000072,1000050,1000073,1000074,1000075,1000076,1000077,1000078,1000079,1000080,1000081,1000082,1000065,1000066,1000003,1000083,1000084,1000085,1000086,1000087,1000088,1000089,1000090,1000003,1000091,1000092,1000093,1000094,1000095,1000096,1000097,1000043,1000003,1000098,1000099,1000046,1000100,1000101,1000102,1000047,1000103,1000003,1000104,1000105,1000090,1000003,1000106,1000107,1000108,1000109,1000110,1000111,1000112,1000065,1000003,1000113,1000114,1000115,1000025,1000003,1000116,1000086,1000117,1000118,1000119,1000120,1000121,1000122,1000123,1000124,1000125,1000126,1000127,1000128,1000129,1000130,1000131,1000132,1000133,1000003,1000134,1000090,1000003,1000135,1000136,1000092,1000137,1000094,1000095,1000096,1000097,1000043,1000003,1000138,1000139,1000047,1000140,1000141,1000142,1000143,1000144,1000145,1000146,1000147,1000148,1000149,1000150,1000151,1000152,1000153,1000154,1000155,1000156,1000157,1000158,1000159,1000160,1000161,1000162,1000097,1000043,1000003,1000163,1000164,1000165,1000166,1000003,1000047,1000167,1000168,1000003,1000169,1000170,1000171,1000003,1000172,1000173,1000174,1000003,1000175,1000176,1000177,1000178,1000179,1000003,1000180,1000181,1000182,1000183,1000184,1000185,1000003,1000092,1000174,1000186,1000187,1000097,1000043,1000003,1000188,1000189,1000047,1000190,1000191,1000069,1000192,1000193,1000003,1000194,1000195,1000003,1000196,1000197,1000198,1000003,1000092,1000199,1000200,1000097,1000043,1000003,1000201,1000202,1000203,1000204,1000205,1000206,1000014,1000003,1000207,1000203,1000204,1000205,1000206,1000014,1000003,1000208,1000209,1000003,1000003]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}